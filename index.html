<!--
  KPI Data Processor – Code V08
  - Firebase v9 Modular SDK via CDN
  - ใช้ firebaseConfig / constants ตามที่กำหนด (ห้ามแก้)
  - Support filenames:
      Daily Sales KPI by .... = daily_kpi
      salebydeptUK4340        = salebydeptUK
      soldmovement43401511    = soldmovement
      storerecap4340          = storerecap
      Weekly Sales KPI by ... = weekly_kpi
  - Groups for Firestore:
      daily group  : daily_kpi, salebydeptUK, soldmovement
      weekly group : weekly_kpi
      recap group  : storerecap
  - Firestore structure:
      stores/{storeId}/{daily_kpi|weekly_kpi|recap_kpi}/{dateKey_fileType}
      artifacts/default-app-id/public/data/kpi_reports/{auto-id}  (summary)

  Version: Code V08 (modular JS)
-->

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>KPI Data Processor – Code V08</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Noto Sans Thai -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: "Noto Sans Thai", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    .kpi-scroll {
      scrollbar-width: thin;
      scrollbar-color: #64748b #0f172a;
    }
    .kpi-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .kpi-scroll::-webkit-scrollbar-track {
      background: #020617;
    }
    .kpi-scroll::-webkit-scrollbar-thumb {
      background-color: #64748b;
      border-radius: 999px;
    }
    .tab-btn-active {
      background-color: #0f172a;
      color: #e5e7eb;
    }
    .tab-btn-inactive {
      color: #9ca3af;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="min-h-screen flex flex-col items-center">
    <!-- HEADER -->
    <header class="w-full max-w-5xl px-4 pt-6 pb-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">
            KPI Data Processor
          </h1>
          <p class="text-sm text-slate-400">
            Process Daily / Weekly / Store Recap KPI files · Code V08
          </p>
        </div>
        <div class="mt-2 md:mt-0 text-right text-xs text-slate-500">
          <div id="firebaseStatus">
            Firebase: <span class="text-amber-400">initializing…</span>
          </div>
          <div id="authStatus">
            Auth: <span class="text-amber-400">signing in…</span>
          </div>
          <div id="uidStatus" class="truncate"></div>
        </div>
      </div>
    </header>

    <!-- MAIN CARD -->
    <main class="w-full max-w-5xl px-4 pb-10 flex-1">
      <div
        class="bg-slate-900/70 border border-slate-800 rounded-2xl shadow-xl overflow-hidden"
      >
        <!-- TAB BAR -->
        <div
          class="border-b border-slate-800 bg-slate-900/80 px-4 py-2 flex items-center justify-between gap-2"
        >
          <div class="flex flex-wrap gap-1">
            <button
              class="tab-btn px-3 py-1.5 rounded-full text-xs md:text-sm font-medium tab-btn-active"
              data-tab="tab-login"
            >
              Login & Role
            </button>
            <button
              class="tab-btn px-3 py-1.5 rounded-full text-xs md:text-sm font-medium tab-btn-inactive"
              data-tab="tab-input"
            >
              Input
            </button>
            <button
              class="tab-btn px-3 py-1.5 rounded-full text-xs md:text-sm font-medium tab-btn-inactive"
              data-tab="tab-report"
            >
              Report
            </button>
            <button
              class="tab-btn px-3 py-1.5 rounded-full text-xs md:text-sm font-medium tab-btn-inactive"
              data-tab="tab-config"
            >
              Config
            </button>
          </div>
          <div class="hidden md:flex flex-col items-end text-xs text-slate-400">
            <div>
              User:
              <span
                id="currentUserDisplay"
                class="font-semibold text-slate-200"
                >-</span
              >
            </div>
            <div>
              Role:
              <span
                id="currentRoleDisplay"
                class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-800 text-sky-300"
              >
                -
              </span>
            </div>
          </div>
        </div>

        <!-- TAB PANELS -->

        <!-- LOGIN TAB START (Code V08) -->
        <section id="tab-login" class="tab-panel px-4 py-4 md:px-6 md:py-6">
          <div class="grid gap-6 md:grid-cols-[1.2fr,1fr]">
            <!-- Login form -->
            <div class="space-y-4">
              <h2 class="text-lg font-semibold">Login & Role</h2>
              <p class="text-sm text-slate-400">
                เลือก role และใส่ KPI password สำหรับ
                <span class="font-medium text-sky-300">Management / Admin</span>.
                Role = Normal ไม่ต้องใช้รหัส
              </p>

              <form id="loginForm" class="space-y-4 mt-2">
                <div class="space-y-1">
                  <label
                    for="loginName"
                    class="text-xs font-medium text-slate-300"
                  >
                    Display name
                  </label>
                  <input
                    id="loginName"
                    type="text"
                    placeholder="เช่น Ek / Manager / Admin"
                    class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  />
                </div>

                <div class="space-y-1">
                  <label
                    for="loginRole"
                    class="text-xs font-medium text-slate-300"
                  >
                    Role
                  </label>
                  <select
                    id="loginRole"
                    class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  >
                    <option value="Normal">Normal (Staff)</option>
                    <option value="Management">Management</option>
                    <option value="Admin">Admin</option>
                  </select>
                </div>

                <div class="space-y-1">
                  <label
                    for="loginPassword"
                    class="text-xs font-medium text-slate-300"
                  >
                    KPI password (สำหรับ Management / Admin)
                  </label>
                  <input
                    id="loginPassword"
                    type="password"
                    placeholder="••••••••"
                    class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  />
                  <p class="text-[10px] text-slate-500">
                    ถ้าเลือก role = Normal สามารถเว้นว่างได้
                  </p>
                </div>

                <div class="flex items-center gap-3 pt-2">
                  <button
                    type="submit"
                    class="inline-flex items-center justify-center rounded-xl bg-sky-500 px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-sky-400 transition-colors"
                  >
                    Set role & continue
                  </button>
                  <button
                    type="button"
                    id="btnLogout"
                    class="inline-flex items-center justify-center rounded-xl border border-slate-600 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800 transition-colors"
                  >
                    Clear role
                  </button>
                </div>

                <p class="text-[11px] text-slate-500 pt-1">
                  หลังจากตั้งค่า role แล้ว ระบบจะพาไปหน้า
                  <span class="text-sky-300 font-medium">Input</span> อัตโนมัติ
                </p>
              </form>
            </div>

            <!-- Role info card -->
            <div class="space-y-3">
              <div
                class="rounded-2xl border border-slate-700 bg-slate-900/80 p-4 text-xs"
              >
                <h3 class="font-semibold text-slate-100 mb-2">
                  Role concept
                </h3>
                <ul class="space-y-1.5 text-slate-400">
                  <li>
                    <span class="font-semibold text-sky-300">Admin</span> – เห็นทุกแท็บ, ปรับ
                    Config, จัดการ store/collections.
                  </li>
                  <li>
                    <span class="font-semibold text-emerald-300"
                      >Management</span
                    >
                    – ใช้งาน Input & Report เต็ม, ปรับ Config ได้บางส่วน.
                  </li>
                  <li>
                    <span class="font-semibold text-indigo-300">Normal</span> –
                    ใช้ Input งานประจำวัน, ดู Report สรุป.
                  </li>
                </ul>
                <p class="mt-3 text-slate-500">
                  Code V08: role ยังเป็น state ในหน้าเว็บ
                  (ยังไม่ enforce permission ที่ Firestore)
                </p>
              </div>
            </div>
          </div>
        </section>
        <!-- LOGIN TAB END (Code V08) -->

        <!-- INPUT TAB START (Code V08) -->
        <section
          id="tab-input"
          class="tab-panel px-4 py-4 md:px-6 md:py-6 hidden"
        >
          <div class="flex flex-col gap-6">
            <div
              class="flex flex-col md:flex-row md:items-baseline md:justify-between gap-2"
            >
              <h2 class="text-lg font-semibold">
                Input – Upload KPI files (.zip / .xlsx)
              </h2>
              <p class="text-xs text-slate-400">
                ถ้าเป็น zip แบบ daily pack / recap pack ให้ใส่ในช่อง Daily หรือ
                Recap ตามจริงได้เลย ระบบจะดูจากชื่อไฟล์ข้างใน
              </p>
            </div>

            <!-- DAILY -->
            <div
              class="rounded-2xl border border-sky-900/70 bg-sky-950/40 p-4 space-y-3"
            >
              <div class="flex items-center justify-between gap-2">
                <div>
                  <h3 class="text-sm font-semibold text-sky-200">
                    Daily Pack (Daily KPI / salebydeptUK / soldmovement)
                  </h3>
                  <p class="text-xs text-slate-400">
                    รองรับไฟล์:
                    <span class="font-medium">Daily Sales KPI by ...</span>,
                    <span class="font-medium">salebydeptUKxxxx</span>,
                    <span class="font-medium">soldmovementxxxx</span>
                  </p>
                </div>
                <span
                  class="text-[10px] px-2 py-1 rounded-full bg-sky-900/60 text-sky-100"
                >
                  Group: <span class="font-mono">daily</span>
                </span>
              </div>

              <div
                class="flex flex-col md:flex-row md:items-center gap-3"
              >
                <input
                  id="dailyFile"
                  type="file"
                  accept=".zip,.xlsx"
                  class="w-full md:flex-1 text-xs file:mr-3 file:rounded-lg file:border-0 file:bg-sky-600 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-slate-950 hover:file:bg-sky-500 cursor-pointer text-slate-300"
                />
                <button
                  id="btnProcessDaily"
                  type="button"
                  class="inline-flex items-center justify-center rounded-xl bg-sky-500 px-4 py-2 text-xs font-semibold text-slate-950 hover:bg-sky-400 transition-colors"
                >
                  Process Daily Pack
                </button>
              </div>
            </div>

            <!-- WEEKLY -->
            <div
              class="rounded-2xl border border-emerald-900/70 bg-emerald-950/40 p-4 space-y-3"
            >
              <div class="flex items-center justify-between gap-2">
                <div>
                  <h3 class="text-sm font-semibold text-emerald-200">
                    Weekly KPI
                  </h3>
                  <p class="text-xs text-slate-400">
                    ไฟล์
                    <span class="font-medium"
                      >Weekly Sales KPI by Store-en-us-....</span
                    >
                  </p>
                </div>
                <span
                  class="text-[10px] px-2 py-1 rounded-full bg-emerald-900/60 text-emerald-100"
                >
                  Group: <span class="font-mono">weekly</span>
                </span>
              </div>

              <div
                class="flex flex-col md:flex-row md:items-center gap-3"
              >
                <input
                  id="weeklyFile"
                  type="file"
                  accept=".zip,.xlsx"
                  class="w-full md:flex-1 text-xs file:mr-3 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-slate-950 hover:file:bg-emerald-400 cursor-pointer text-slate-300"
                />
                <button
                  id="btnProcessWeekly"
                  type="button"
                  class="inline-flex items-center justify-center rounded-xl bg-emerald-500 px-4 py-2 text-xs font-semibold text-slate-950 hover:bg-emerald-400 transition-colors"
                >
                  Process Weekly
                </button>
              </div>
            </div>

            <!-- RECAP -->
            <div
              class="rounded-2xl border border-indigo-900/70 bg-indigo-950/40 p-4 space-y-3"
            >
              <div class="flex items-center justify-between gap-2">
                <div>
                  <h3 class="text-sm font-semibold text-indigo-200">
                    Store Recap
                  </h3>
                  <p class="text-xs text-slate-400">
                    ไฟล์ <span class="font-medium">storerecapxxxx</span> หรือ
                    recap pack อื่น ๆ
                  </p>
                </div>
                <span
                  class="text-[10px] px-2 py-1 rounded-full bg-indigo-900/60 text-indigo-100"
                >
                  Group: <span class="font-mono">recap</span>
                </span>
              </div>

              <div
                class="flex flex-col md:flex-row md:items-center gap-3"
              >
                <input
                  id="recapFile"
                  type="file"
                  accept=".zip,.xlsx"
                  class="w-full md:flex-1 text-xs file:mr-3 file:rounded-lg file:border-0 file:bg-indigo-500 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-slate-950 hover:file:bg-indigo-400 cursor-pointer text-slate-300"
                />
                <button
                  id="btnProcessRecap"
                  type="button"
                  class="inline-flex items-center justify-center rounded-xl bg-indigo-500 px-4 py-2 text-xs font-semibold text-slate-950 hover:bg-indigo-400 transition-colors"
                >
                  Process Recap
                </button>
              </div>
            </div>

            <p class="text-[11px] text-slate-500">
              ถ้าเป็น .zip แบบตั้งรหัส (encrypted zip) JSZip จะอ่านไม่ได้
              และระบบจะขึ้นข้อความ
              <span class="font-mono text-red-400"
                >Encrypted zip are not supported</span
              >
            </p>
          </div>
        </section>
        <!-- INPUT TAB END (Code V08) -->

        <!-- REPORT TAB START (Code V08) -->
        <section
          id="tab-report"
          class="tab-panel px-4 py-4 md:px-6 md:py-6 hidden"
        >
          <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between gap-2">
              <h2 class="text-lg font-semibold">
                Report – Processed files overview
              </h2>
              <button
                id="btnRefreshReport"
                class="inline-flex items-center justify-center rounded-xl border border-slate-700 px-3 py-1.5 text-xs text-slate-200 hover:bg-slate-800 transition-colors"
                type="button"
              >
                Refresh
              </button>
            </div>
            <p class="text-xs text-slate-400">
              แสดงสรุปไฟล์ที่ถูกประมวลผลจาก Daily / Weekly / Recap (ตาม state
              ปัจจุบัน)
            </p>

            <pre
              id="reportOutput"
              class="kpi-scroll mt-2 max-h-72 rounded-2xl bg-slate-950/80 border border-slate-800 px-3 py-2 text-[11px] leading-relaxed text-slate-200 overflow-auto"
            ></pre>
          </div>
        </section>
        <!-- REPORT TAB END (Code V08) -->

        <!-- CONFIG TAB START (Code V08) -->
        <section
          id="tab-config"
          class="tab-panel px-4 py-4 md:px-6 md:py-6 hidden"
        >
          <div class="space-y-5">
            <h2 class="text-lg font-semibold">Config – Firestore</h2>
            <p class="text-xs text-slate-400">
              Daily collection root ถูก fix เป็น
              <span class="font-mono">stores</span> (DAILY_COLLECTION_ROOT).
              ตรงนี้ตั้งชื่อ subcollection ของแต่ละ group
            </p>

            <div class="grid gap-4 md:grid-cols-2">
              <div
                class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4 space-y-3 text-xs"
              >
                <h3 class="font-semibold text-slate-100 mb-1">
                  Subcollections per group
                </h3>
                <div class="space-y-2">
                  <div class="flex items-center justify-between gap-2">
                    <label
                      for="cfgDailyCollection"
                      class="text-slate-300"
                      >Daily group</label
                    >
                    <input
                      id="cfgDailyCollection"
                      type="text"
                      class="w-40 rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
                      value="daily_kpi"
                    />
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <label
                      for="cfgWeeklyCollection"
                      class="text-slate-300"
                      >Weekly group</label
                    >
                    <input
                      id="cfgWeeklyCollection"
                      type="text"
                      class="w-40 rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
                      value="weekly_kpi"
                    />
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <label
                      for="cfgRecapCollection"
                      class="text-slate-300"
                      >Recap group</label
                    >
                    <input
                      id="cfgRecapCollection"
                      type="text"
                      class="w-40 rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
                      value="recap_kpi"
                    />
                  </div>
                </div>
                <button
                  id="btnApplyConfig"
                  type="button"
                  class="mt-3 inline-flex items-center justify-center rounded-xl bg-slate-800 px-3 py-1.5 text-xs text-slate-100 hover:bg-slate-700 transition-colors"
                >
                  Apply
                </button>
              </div>

              <div
                class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4 text-xs space-y-2"
              >
                <h3 class="font-semibold text-slate-100 mb-1">
                  Firestore paths
                </h3>
                <p class="text-slate-400">
                  ตัวอย่างที่บันทึกจริง:
                </p>
                <pre
                  class="text-[10px] text-slate-300 bg-slate-900/80 rounded-lg px-2 py-2 overflow-auto"
                >
stores/{storeId}/daily_kpi/{dateKey_fileType}
stores/{storeId}/weekly_kpi/{dateKey_fileType}
stores/{storeId}/recap_kpi/{dateKey_fileType}

(สรุปกลาง)
artifacts/default-app-id/public/data/kpi_reports/{auto-id}
                </pre>
                <p class="text-slate-500">
                  PUBLIC_COLLECTION_PATH ใช้เก็บ summary ทุกไฟล์ที่ประมวลผล
                </p>
              </div>
            </div>
          </div>
        </section>
        <!-- CONFIG TAB END (Code V08) -->
      </div>

      <!-- CONSOLE LOG -->
      <section class="mt-4 space-y-2">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-slate-200">Console</h3>
          <button
            id="btnClearLog"
            type="button"
            class="inline-flex items-center justify-center rounded-xl border border-slate-700 px-3 py-1 text-[11px] text-slate-300 hover:bg-slate-800 transition-colors"
          >
            Clear log
          </button>
        </div>
        <pre
          id="consoleLog"
          class="kpi-scroll max-h-52 rounded-2xl bg-black/80 border border-slate-900 px-3 py-2 text-[11px] leading-relaxed text-slate-200 overflow-auto"
        ></pre>
      </section>
    </main>
  </div>

  <!-- JS LIBS (global for all modules) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- MAIN MODULES – Code V08 -->
  <script type="module" src="./js/kpi-core-v08.js"></script>
  <script type="module" src="./js/kpi-login-v08.js"></script>
  <script type="module" src="./js/kpi-input-v08.js"></script>
  <script type="module" src="./js/kpi-report-v08.js"></script>
</body>
</html>